<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Phylab - Admin Page</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script>
      (function () {
        emailjs.init("lJ6EFXKyc4N6yIyEG");
      })();
    </script>
    <script src="inventory_data.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
    <script src="supabase_fetch.js"></script>
    <link rel="stylesheet" href="Phylab_theme_vars.css" />
    <link rel="stylesheet" href="PhyLab_admin_page_style.css" />
  </head>
  <body class="wholescreen">
    <div class="admin-header">
      <button
        class="mobile-menu-toggle"
        id="mobileMenuToggle"
        aria-label="Open menu"
      >
        <svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <line x1="3" y1="12" x2="21" y2="12"></line>
          <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
      </button>
      <div class="header-title">
        <h1 class="title">PhyLab Admin</h1>
      </div>
      <div class="logout">
        <button
          class="logout-button"
          onclick="window.location.href = 'PhyLab_login.html'"
        >
          Logout
        </button>
      </div>
    </div>

    <div class="admin-layout">
      <div class="sidebar-overlay" id="sidebarOverlay"></div>
      <!-- Sidebar Navigation -->
      <aside class="admin-sidebar">
        <nav class="sidebar-nav">
          <button class="nav-item active" data-page="dashboard">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="3" y="3" width="7" height="9"></rect>
              <rect x="14" y="3" width="7" height="5"></rect>
              <rect x="14" y="12" width="7" height="9"></rect>
              <rect x="3" y="16" width="7" height="5"></rect>
            </svg>
            <span>Dashboard</span>
          </button>
          <button class="nav-item" data-page="approvals">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <span>Borrow Requests</span>
            <span class="nav-badge" id="pendingCount">0</span>
          </button>
          <button class="nav-item" data-page="loans">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
              <line x1="1" y1="10" x2="23" y2="10"></line>
            </svg>
            <span>Active Loans</span>
            <span class="nav-badge" id="loansCount">0</span>
          </button>
          <button class="nav-item" data-page="equipment">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"
              ></path>
            </svg>
            <span>Inventory</span>
          </button>
          <button class="nav-item" data-page="reviews">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
              ></path>
            </svg>
            <span>Reviews</span>
            <span class="nav-badge" id="reviewsCount">0</span>
          </button>
        </nav>
      </aside>

      <!-- Main Content Area -->
      <main class="admin-main">
        <!-- Dashboard Page -->
        <section class="page-section active" data-page="dashboard">
          <div class="page-header">
            <h2 class="page-title">Dashboard Overview</h2>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon pending-icon">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
              </div>
              <div class="stat-info">
                <span class="stat-value" id="statPending">0</span>
                <span class="stat-label">Pending Requests</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon loans-icon">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                  <line x1="1" y1="10" x2="23" y2="10"></line>
                </svg>
              </div>
              <div class="stat-info">
                <span class="stat-value" id="statLoans">0</span>
                <span class="stat-label">Active Loans</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon equipment-icon">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"
                  ></path>
                </svg>
              </div>
              <div class="stat-info">
                <span class="stat-value" id="statEquipment">0</span>
                <span class="stat-label">Total Equipment</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon reviews-icon">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                  ></path>
                </svg>
              </div>
              <div class="stat-info">
                <span class="stat-value" id="statReviews">0</span>
                <span class="stat-label">Reviews</span>
              </div>
            </div>
          </div>

          <div class="dashboard-grid">
            <div class="dashboard-card borrowers-list-card">
              <div class="card-header">
                <h3>Recent Borrowers</h3>
                <button class="view-all-btn" onclick="showPage('approvals')">
                  View All
                </button>
              </div>
              <div
                class="borrowers-table-container"
                id="dashboardBorrowersList"
              >
                <!-- Populated by JS -->
              </div>
            </div>

            <div class="dashboard-card chart-card">
              <div class="card-header">
                <h3>Frequent Borrowed Items</h3>
                <button onclick="resetGraphData()" class="reset-graph-btn">
                  Reset
                </button>
              </div>
              <div class="chart-box">
                <canvas id="liveChart"></canvas>
              </div>
            </div>
          </div>
        </section>

        <!-- Borrow Approvals Page -->
        <section class="page-section" data-page="approvals">
          <div class="page-header">
            <h2 class="page-title">Borrow Requests</h2>
            <p class="page-subtitle">
              Review and approve or reject borrowing requests
            </p>
          </div>
          <!-- Per-request selection controls shown on each request header -->
          <div class="approvals-container" id="approvalsContainer">
            <!-- Populated by JS -->
          </div>
        </section>

        <!-- Active Loans Page -->
        <section class="page-section" data-page="loans">
          <div class="page-header">
            <h2 class="page-title">Active Loans</h2>
            <p class="page-subtitle">
              Currently borrowed items awaiting return
            </p>
          </div>
          <div class="loans-container" id="loansContainer">
            <!-- Populated by JS -->
          </div>
        </section>

        <!-- Equipment Management Page -->
        <section class="page-section" data-page="equipment">
          <div class="page-header">
            <h2 class="page-title">Invontery Management</h2>
            <p class="page-subtitle">Manage inventory stock levels</p>
          </div>
          <div class="equipment-toolbar">
            <div class="search-bar">
              <div class="search-icon" aria-hidden="true">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <circle cx="11" cy="11" r="7"></circle>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
              </div>
              <input
                id="inventorySearch"
                class="search-input"
                type="search"
                placeholder="Search equipment, tools, or items..."
                aria-label="Search inventory"
              />
            </div>
            <div class="equipment-filters">
              <button class="category-button active" data-filter="all">
                All Items
              </button>
              <button class="category-button" data-filter="apparatus">
                Apparatus
              </button>
              <button class="category-button" data-filter="tools">Tools</button>
              <button class="category-button" data-filter="equipment">
                Equipment
              </button>
            </div>
          </div>
          <div class="inventory-grid">
            <!-- Inventory cards are rendered dynamically by `renderInventoryGrid()` -->
          </div>
        </section>

        <!-- Reviews Page -->
        <section class="page-section" data-page="reviews">
          <div class="page-header">
            <h2 class="page-title">User Reviews</h2>
            <p class="page-subtitle">Feedback and comments from borrowers</p>
          </div>
          <div class="reviews-container" id="reviewsContainer">
            <!-- Populated by JS -->
          </div>
        </section>
      </main>
    </div>

    <!-- Borrowing Details Modal (kept for detailed view) -->
    <div id="Borrowing-Details-window" class="Borrowing-Details-modal">
      <div class="Borrow-Details-content">
        <div class="Borrow-Details-header">
          <h2>Borrowing Details</h2>
          <span
            class="close-details-btn"
            onclick="
              document.getElementById(
                'Borrowing-Details-window',
              ).style.display = 'none'
            "
            >&times;</span
          >
        </div>

        <div class="Borrow-Details-body">
          <div class="info-grid">
            <div class="info-card">
              <h3>Item Information</h3>
              <div class="card-inner">
                <img
                  id="det-item-img"
                  src=""
                  alt="Item"
                  style="width: 80px; height: 80px; object-fit: cover"
                />
                <div class="text-content">
                  <strong
                    id="det-item-name"
                    style="font-size: 1.1rem; color: var(--color-primary)"
                    >Item Name</strong
                  >
                  <p class="sub-text">Apparatus</p>

                  <p>
                    <strong>Description:</strong>
                    <span id="det-description">---</span>
                  </p>
                  <p>
                    <strong>Inventory ID:</strong>
                    <span id="det-inv-id">---</span>
                  </p>
                  <p>
                    <strong>Condition:</strong>
                    <span id="det-condition">---</span>
                  </p>
                </div>
              </div>
            </div>

            <div class="info-card">
              <h3>Borrower Information</h3>
              <div class="card-inner">
                <div class="user-avatar">
                  <svg viewBox="0 0 24 24">
                    <path
                      d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"
                    />
                  </svg>
                </div>
                <div class="text-content">
                  <strong id="det-borrower-name" style="font-size: 1.1rem"
                    >Name</strong
                  >
                  <p class="sub-text" id="det-borrower-id">ID: 0000</p>

                  <p>
                    <strong>Teacher:</strong> <span id="det-teacher">---</span>
                  </p>
                  <p><strong>Class:</strong> <span id="det-class">---</span></p>
                  <p>
                    <strong>Contact:</strong> <span id="det-email">---</span>
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="details-timeline-section">
            <h3>Borrowing Details</h3>
            <div class="timeline-grid">
              <div>
                <p class="label">Borrow Date:</p>
                <p class="value" id="det-borrow-date">---</p>
              </div>
              <div>
                <p class="label">Return Date:</p>
                <p class="value" id="det-return-date">---</p>
              </div>
              <div>
                <p class="label">Status:</p>
                <span class="status-tag" id="det-status">Pending</span>
              </div>
            </div>
            <div class="purpose-box">
              <strong>Purpose:</strong>
              <p
                id="det-purpose"
                style="
                  background: #f9f9f9;
                  padding: 10px;
                  margin-top: 5px;
                  border-radius: 4px;
                "
              >
                Loading...
              </p>
            </div>

            <!-- Admin Remark Display -->
            <div
              class="remark-display"
              id="det-remark-section"
              style="display: none"
            >
              <div class="remark-display-header">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                  ></path>
                  <path
                    d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                  ></path>
                </svg>
                Admin Remark
                <span class="remark-display-type" id="det-remark-type"></span>
              </div>
              <p class="remark-display-text" id="det-remark-text"></p>
              <div class="remark-display-meta" id="det-remark-meta"></div>
            </div>
          </div>
        </div>

        <div class="Borrow-Details-footer">
          <button
            class="secondary-btn"
            onclick="
              document.getElementById(
                'Borrowing-Details-window',
              ).style.display = 'none'
            "
          >
            Close
          </button>
          <button class="primary-btn" id="sendReminderBtn">
            Send Reminder
          </button>
        </div>
      </div>
    </div>

    <!-- Custom Notification Popup -->
    <div id="notificationPopup" class="notification-popup">
      <div class="notification-content">
        <div class="notification-logo" id="notificationLogo">
          <img src="Phylab.png" alt="PhyLab" />
        </div>
        <div class="notification-icon" id="notificationIcon">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="28"
            height="28"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        </div>
        <p class="notification-message" id="notificationMessage">
          Message here
        </p>
        <button class="notification-close-btn" onclick="hideNotification()">
          OK
        </button>
      </div>
    </div>

    <!-- Admin Remark Modal -->
    <div id="remarkModal" class="remark-modal">
      <div class="remark-modal-content">
        <div class="remark-modal-header">
          <h3>Add Remark</h3>
          <span class="close-remark-btn" onclick="closeRemarkModal()"
            >&times;</span
          >
        </div>
        <div class="remark-modal-body">
          <p class="remark-item-label">
            Item: <strong id="remarkItemName">—</strong>
          </p>
          <label for="remarkType">Issue Type</label>
          <select id="remarkType" class="remark-select">
            <option value="">— Select type —</option>
            <option value="damaged">Damaged</option>
            <option value="missing-parts">Missing Parts</option>
            <option value="late-return">Late Return</option>
            <option value="wrong-item">Wrong Item Returned</option>
            <option value="other">Other</option>
          </select>
          <label for="remarkText">Description</label>
          <textarea
            id="remarkText"
            class="remark-textarea"
            rows="4"
            placeholder="Describe the issue or note..."
          ></textarea>
        </div>
        <div class="remark-modal-footer">
          <button class="secondary-btn" onclick="closeRemarkModal()">
            Cancel
          </button>
          <button class="primary-btn" onclick="saveRemark()">
            Save Remark
          </button>
        </div>
      </div>
    </div>

    <!-- Item Details Edit Modal (moved out to top-level so it can display independently) -->
    <div id="itemEditModal" class="remark-modal">
      <div class="remark-modal-content">
        <div class="remark-modal-header">
          <h3>Edit Item Details</h3>
          <span class="close-remark-btn" onclick="closeItemEditModal()"
            >&times;</span
          >
        </div>
        <div class="remark-modal-body">
          <p class="remark-item-label">
            Item: <strong id="editItemName">—</strong>
          </p>
          <label for="editItemType">Type</label>
          <input
            id="editItemType"
            class="remark-select"
            type="text"
            placeholder="e.g., Power Supply"
          />
          <label for="editItemUse">Use</label>
          <input
            id="editItemUse"
            class="remark-select"
            type="text"
            placeholder="e.g., Provide DC power"
          />
          <label for="editItemCabinet">Cabinet</label>
          <input
            id="editItemCabinet"
            class="remark-select"
            type="text"
            placeholder="e.g., Cabinet 1"
          />
          <label for="editItemDescription">Description</label>
          <textarea
            id="editItemDescription"
            class="remark-textarea"
            rows="4"
            placeholder="Describe the item..."
          ></textarea>
        </div>
        <div class="remark-modal-footer">
          <button class="secondary-btn" onclick="closeItemEditModal()">
            Cancel
          </button>
          <button class="primary-btn" onclick="saveItemDetails()">
            Save Details
          </button>
        </div>
      </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmModal" class="confirm-modal">
      <div class="confirm-modal-content">
        <div class="confirm-modal-header">
          <h3 id="confirmTitle">Confirm Action</h3>
        </div>
        <div class="confirm-modal-body">
          <p id="confirmMessage">Are you sure you want to proceed?</p>
        </div>
        <div class="confirm-modal-footer">
          <button
            class="secondary-btn"
            id="confirmCancelBtn"
            onclick="hideConfirmModal()"
          >
            Cancel
          </button>
          <button
            class="primary-btn"
            id="confirmOkBtn"
            onclick="executeConfirmCallback()"
          >
            Confirm
          </button>
        </div>
      </div>
    </div>

    <!-- Image lightbox for review images -->
    <div id="reviewImageModal" class="image-modal" style="display: none">
      <div class="image-modal-content">
        <button class="image-modal-close" onclick="closeReviewImage()">
          &times;
        </button>
        <img id="reviewImageView" src="" alt="" />
        <div id="reviewImageCaption" class="image-modal-caption"></div>
      </div>
    </div>

    <!-- Modular JavaScript Components -->
    <script src="js/admin-utils.js"></script>
    <script src="js/admin-notifications.js"></script>
    <script src="js/admin-emailjs.js"></script>
    <script src="js/admin-navigation.js"></script>
    <script src="js/admin-dashboard.js"></script>
    <script src="js/admin-borrow-requests.js"></script>
    <script src="js/admin-active-loans.js"></script>
    <script src="js/admin-reviews.js"></script>
    <script src="js/admin-remarks.js"></script>
    <script src="js/admin-inventory.js"></script>
  </body>
</html>
