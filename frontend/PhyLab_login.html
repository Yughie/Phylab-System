<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PhyLab - Physics Laboratory Inventory System</title>
    <link rel="stylesheet" href="Phylab_theme_vars.css" />
    <link rel="stylesheet" href="Phylab_style.css" />
    <script
      src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"
      onload="emailjs && emailjs.init('lJ6EFXKyc4N6yIyEG')"
    ></script>
    <script>
      (function () {
        function initEmailJS() {
          if (window.emailjs && typeof emailjs.init === "function") {
            try {
              emailjs.init("lJ6EFXKyc4N6yIyEG");
              window._emailjsReady = true;
            } catch (e) {
              console.warn("emailjs.init failed:", e);
            }
          } else {
            window._emailjsReady = false;
            var t = setInterval(function () {
              if (window.emailjs && typeof emailjs.init === "function") {
                try {
                  emailjs.init("lJ6EFXKyc4N6yIyEG");
                  window._emailjsReady = true;
                } catch (e) {
                  console.warn("emailjs.init failed:", e);
                }
                clearInterval(t);
              }
            }, 250);
          }
        }

        if (
          document.readyState === "complete" ||
          document.readyState === "interactive"
        ) {
          initEmailJS();
        } else {
          document.addEventListener("DOMContentLoaded", initEmailJS);
        }
      })();
    </script>
    <style>
      /* Simple centered modal used for login success/failure messages */
      .phylab-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
        /* place modal slightly higher than center */
        align-items: flex-start;
        justify-content: center;
        padding-top: 10vh;
        background: rgba(0, 0, 0, 0.35);
        z-index: 9999;
      }
      .phylab-modal-content {
        background: #fff;
        padding: 18px 22px;
        border-radius: 8px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
        min-width: 260px;
        text-align: center;
        font-family: inherit;
        font-size: 16px;
      }
      .phylab-modal.success .phylab-modal-content {
        border-left: 6px solid #2ecc71;
      }
      .phylab-modal.error .phylab-modal-content {
        border-left: 6px solid #e74c3c;
      }
      /* Inline form error styling */
      .form-error {
        display: none;
        color: #e74c3c;
        font-size: 14px;
        margin-top: 8px;
      }
      .input-error {
        outline: none;
        border-color: #e74c3c !important;
        box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.08);
      }
      /* Password toggle styles */
      .input-password,
      .input-group {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        gap: 6px;
      }

      .input-with-toggle {
        position: relative;
        display: flex;
        align-items: center;
      }

      .password-toggle {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: transparent;
        border: none;
        padding: 6px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--color-text, #111);
      }

      .password-toggle:focus {
        outline: 2px solid rgba(0, 0, 0, 0.12);
        border-radius: 4px;
      }
      .password-input,
      .form-input {
        width: 100%;
        padding-right: 44px; /* room for the toggle */
        box-sizing: border-box;
      }
    </style>
  </head>
  <body class="wholescreen">
    <div id="login-section" class="bg_login-form">
      <div class="second_bg_login-form">
        <div class="header-login-form">
          <h1 class="header1">PhyLab</h1>
          <p class="sub-header">Physics Laboratory Inventory System</p>
        </div>

        <div class="input-username">
          <label for="username" class="username-label">Email</label>
          <input
            type="text"
            id="username"
            class="username-input"
            name="username"
            required
          />
        </div>

        <div class="input-password">
          <label for="password" class="password-label">Password</label>
          <div class="input-with-toggle">
            <input
              type="password"
              id="password_login"
              class="password-input"
              name="password"
              required
            />
            <button
              type="button"
              class="password-toggle"
              aria-pressed="false"
              aria-label="Show password"
              onclick="togglePassword('password_login', this)"
            >
              <!-- eye icon (show) -->
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true"
              >
                <path
                  d="M12 5C7 5 2.7 8.1 1 12c1.7 3.9 6 7 11 7s9.3-3.1 11-7c-1.7-3.9-6-7-11-7z"
                  stroke="currentColor"
                  stroke-width="1.2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <circle
                  cx="12"
                  cy="12"
                  r="3"
                  stroke="currentColor"
                  stroke-width="1.2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
          </div>
        </div>

        <div class="checkbox-button">
          <div class="checkbox-button-rm1">
            <input
              type="checkbox"
              id="remember"
              class="remember-check"
              name="remember"
            />
            <label for="remember" class="remember-label">Remember me</label>
          </div>
          <button class="admin-button" onclick="openAdminModal()">
            Admin Login
          </button>
        </div>

        <p id="loginError" class="form-error" role="alert"></p>
        <button class="login" onclick="handleLogin()">Login</button>

        <div class="register-container-login">
          <label class="register-label">
            Don't have an account?
            <span class="register-button-link" onclick="switchView('register')"
              >Register</span
            >
          </label>
        </div>
      </div>
    </div>

    <div id="register-section" class="bg_register-form" style="display: none">
      <div class="second_bg_register-form">
        <div class="header-register-form">
          <h1 class="header1">Create Account</h1>
          <p class="sub-header">Join the Physics Laboratory Inventory System</p>
        </div>

        <form id="registerForm">
          <div class="input-group">
            <label for="fullname" class="input-label">Full Name</label>
            <input
              type="text"
              id="fullname"
              class="form-input"
              placeholder="John Doe"
              required
            />
          </div>

          <div class="input-group">
            <label for="id_number" class="input-label"
              >Student / Employee ID</label
            >
            <input
              type="text"
              id="id_number"
              class="form-input"
              placeholder="Student / Employee ID"
              title="ID number"
              maxlength="20"
              required
            />
          </div>

          <div class="input-group">
            <label for="email" class="input-label">Email Address</label>
            <input
              type="email"
              id="email"
              class="form-input"
              placeholder="example@univ.edu"
              required
            />
          </div>

          <div class="input-group">
            <label for="password" class="input-label">Password</label>
            <input
              type="password"
              id="password_reg"
              class="form-input"
              placeholder="••••••••"
              required
            />
            <button
              type="button"
              class="password-toggle"
              aria-pressed="false"
              aria-label="Show password"
              onclick="togglePassword('password_reg', this)"
            >
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true"
              >
                <path
                  d="M12 5C7 5 2.7 8.1 1 12c1.7 3.9 6 7 11 7s9.3-3.1 11-7c-1.7-3.9-6-7-11-7z"
                  stroke="currentColor"
                  stroke-width="1.2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <circle
                  cx="12"
                  cy="12"
                  r="3"
                  stroke="currentColor"
                  stroke-width="1.2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
          </div>

          <button type="submit" class="register-btn">Register</button>
        </form>

        <div class="login-link-container">
          <p class="login-text">
            Already have an account?
            <span class="login-span" onclick="switchView('login')"
              >Login here</span
            >
          </p>
        </div>
      </div>
    </div>
    <!-- Modal used for brief notifications (login success/failure) -->
    <div
      id="phylab-modal"
      class="phylab-modal"
      role="dialog"
      aria-live="polite"
    >
      <div class="phylab-modal-content">
        <p id="phylab-modal-message"></p>
      </div>
    </div>

    <!-- Admin access modal (replaces prompt) -->
    <div
      id="adminModal"
      class="phylab-modal"
      role="dialog"
      aria-live="polite"
      style="display: none"
    >
      <div class="phylab-modal-content">
        <h3 style="margin: 0 0 8px 0; font-size: 18px">Admin Access</h3>
        <p style="margin: 0 0 12px 0; color: var(--color-text-light)">
          Enter the admin access key to continue.
        </p>
        <input
          id="adminKeyInput"
          type="password"
          placeholder="Access key"
          style="
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            box-sizing: border-box;
          "
        />
        <p id="adminKeyError" class="form-error" style="margin-top: 8px"></p>
        <div
          style="
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 12px;
          "
        >
          <button class="secondary-btn" id="adminCancelBtn">Cancel</button>
          <button class="primary-btn" id="adminSubmitBtn">Submit</button>
        </div>
      </div>
    </div>

    <script>
      // Global modal helper reused by login and registration flows
      function showPhylabModal(message, isSuccess = true, callback) {
        const modal = document.getElementById("phylab-modal");
        const msgEl = document.getElementById("phylab-modal-message");
        if (!modal || !msgEl) {
          // If modal markup is missing (unexpected), create a lightweight inline modal instead
          try {
            const dynamic = document.createElement("div");
            dynamic.id = "phylab-modal";
            dynamic.className = "phylab-modal";
            dynamic.style.display = "flex";
            dynamic.innerHTML = `<div class="phylab-modal-content ${isSuccess ? "success" : "error"}"><p id="phylab-modal-message">${message}</p></div>`;
            document.body.appendChild(dynamic);
            setTimeout(() => {
              dynamic.style.display = "none";
              document.body.removeChild(dynamic);
              if (typeof callback === "function") callback();
            }, 2000);
          } catch (e) {
            console.warn(
              "phylab modal missing and dynamic creation failed:",
              e,
            );
          }
          return;
        }
        msgEl.textContent = message;
        modal.classList.remove("success", "error");
        modal.classList.add(isSuccess ? "success" : "error");
        modal.style.display = "flex";
        setTimeout(() => {
          modal.style.display = "none";
          if (typeof callback === "function") callback();
        }, 2000);
      }

      // EmailJS helpers for login page (sanitize + safe send)
      function sanitizeEmail(raw) {
        if (!raw || typeof raw !== "string") return "";
        const s = raw.trim();
        const m = s.match(/[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}/);
        return m ? m[0] : "";
      }

      function safeSendEmail(serviceId, templateId, templateParams) {
        return new Promise((resolve, reject) => {
          if (!window.emailjs || typeof emailjs.send !== "function")
            return reject(new Error("EmailJS not available"));
          const params = Object.assign({}, templateParams);
          if (params.to_email) params.to_email = sanitizeEmail(params.to_email);
          if (
            !params.to_email &&
            params.to_name &&
            params.to_name.includes("@")
          )
            params.to_email = sanitizeEmail(params.to_name);
          if (!params.to_email)
            return reject(new Error("Invalid recipient email"));
          console.log("EmailJS send (login):", {
            to_email: params.to_email,
            to_name: params.to_name,
          });
          emailjs
            .send(serviceId, templateId, params)
            .then(resolve)
            .catch(reject);
        });
      }

      // Configure these with your EmailJS Service & Template IDs
      const EMAILJS_SERVICE_ID = "your_service_id";
      const EMAILJS_TEMPLATE_ID = "your_template_id";

      // Auto-format / sanitize ID input (permissive: allow alphanumeric, dash, space)
      (function attachIdFormatter() {
        const idInput = document.getElementById("id_number");
        if (!idInput) return;

        function sanitize(raw) {
          // allow letters, digits, spaces and dashes; limit to 20 chars
          return (raw || "").replace(/[^A-Za-z0-9\-\s]/g, "").slice(0, 20);
        }

        idInput.addEventListener("input", () => {
          const v = idInput.value;
          idInput.value = sanitize(v);
          try {
            idInput.setSelectionRange(
              idInput.value.length,
              idInput.value.length,
            );
          } catch (err) {}
        });

        idInput.addEventListener("paste", (e) => {
          e.preventDefault();
          const paste =
            (e.clipboardData || window.clipboardData).getData("text") || "";
          idInput.value = sanitize(paste);
          try {
            idInput.setSelectionRange(
              idInput.value.length,
              idInput.value.length,
            );
          } catch (err) {}
        });
      })();
      class UserProfile {
        constructor(fullname, idNumber, email, password) {
          this.fullname = fullname;
          this.idNumber = idNumber;
          this.email = email;
          this.password = password;
          this.dateRegistered = new Date().toLocaleDateString();
        }

        getProfileSummary() {
          return `${this.fullname} (${this.idNumber})`;
        }
      }

      const getUsers = () =>
        JSON.parse(localStorage.getItem("phylab_users")) || [];

      function switchView(viewName) {
        const loginSection = document.getElementById("login-section");
        const registerSection = document.getElementById("register-section");

        if (viewName === "register") {
          loginSection.style.display = "none";
          registerSection.style.display = "flex";
        } else {
          registerSection.style.display = "none";
          loginSection.style.display = "flex";
        }
      }

      document
        .getElementById("registerForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const fullname = document.getElementById("fullname").value.trim();
          const idNumber = document.getElementById("id_number").value.trim();
          const email = document.getElementById("email").value.trim();
          const password = document.getElementById("password_reg").value;

          // Generic ID validation: allow 4-20 characters (letters, digits, spaces, dashes)
          const idRegex = /^[A-Za-z0-9\-\s]{4,20}$/;
          if (!idRegex.test(idNumber)) {
            showPhylabModal(
              "ID must be 4–20 characters (letters, digits, spaces, dashes allowed)",
              false,
            );
            return;
          }

          // Basic email validation
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(email)) {
            showPhylabModal("Please enter a valid email address.", false);
            return;
          }

          // Disable submit button to prevent duplicates
          const submitBtn = this.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = "Registering...";
          }

          const payload = {
            full_name: fullname,
            id_number: idNumber,
            email: email,
            password: password,
          };

          try {
            const res = await fetch("http://127.0.0.1:8000/api/register/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });

            if (res.status === 201) {
              const data = await res.json();
              // If backend returned a token and user info, auto-login and redirect
              if (data.token) {
                const userObj = {
                  id: data.id,
                  email: data.email,
                  fullname: data.full_name || data.fullname || "",
                  idNumber: data.id_number || data.idNumber || "",
                };
                sessionStorage.setItem("auth_token", data.token);
                sessionStorage.setItem("current_user", JSON.stringify(userObj));
                showPhylabModal(
                  `Registration successful. Welcome ${userObj.fullname}!`,
                  true,
                  () => {
                    window.location.href = "PhyLab_user_page.html";
                  },
                );
              } else {
                showPhylabModal(
                  `Registration successful. Welcome ${fullname}!`,
                  true,
                  () => {
                    switchView("login");
                  },
                );
              }
              this.reset();
              // Attempt to send a welcome email (non-blocking). Configure IDs above.
              try {
                const params = {
                  to_email: email,
                  to_name: fullname,
                  user_id: (data && data.id) || "",
                };
                safeSendEmail(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params)
                  .then(() => console.log("Welcome email sent"))
                  .catch((e) => console.warn("Welcome email not sent", e));
              } catch (e) {
                console.warn("Welcome email setup failed", e);
              }
            } else {
              const err = await res.json().catch(() => ({}));
              let msg = "Registration failed.";
              if (err && typeof err === "object") {
                // Build readable message from serializer errors
                msg = Object.entries(err)
                  .map(
                    ([k, v]) => `${k}: ${Array.isArray(v) ? v.join(" ") : v}`,
                  )
                  .join(" | ");
              }
              showPhylabModal(msg, false);
            }
          } catch (networkErr) {
            console.error("Network error during registration", networkErr);
            showPhylabModal("Network error: could not reach server.", false);
          } finally {
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = "Register";
            }
          }
        });

      async function handleLogin() {
        const idInput = document.getElementById("username").value.trim();
        const passInput = document.getElementById("password_login").value;

        const submitBtn = document.querySelector(".login");
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = "Signing in...";
        }

        try {
          const payload = { email: idInput, password: passInput };
          const res = await fetch("http://127.0.0.1:8000/api/login/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (res.ok) {
            const data = await res.json();
            // store token for subsequent requests
            if (data.token) sessionStorage.setItem("auth_token", data.token);

            // build basic user object
            const userObj = {
              id: data.id,
              email: data.email,
              fullname: data.full_name || data.fullname || "",
              idNumber: data.id_number || data.idNumber || "",
            };

            // If fullname missing, fetch user detail using token
            if (
              (!userObj.fullname || userObj.fullname.trim() === "") &&
              data.token
            ) {
              try {
                const detailRes = await fetch(
                  `http://127.0.0.1:8000/api/users/${data.id}/`,
                  {
                    headers: { Authorization: "Token " + data.token },
                  },
                );
                if (detailRes.ok) {
                  const detail = await detailRes.json();
                  userObj.fullname =
                    detail.full_name ||
                    detail.fullName ||
                    detail.fullname ||
                    userObj.fullname;
                  userObj.idNumber =
                    detail.id_number || detail.idNumber || userObj.idNumber;
                }
              } catch (e) {
                console.warn("Could not fetch user details after login", e);
              }
            }

            sessionStorage.setItem("current_user", JSON.stringify(userObj));
            showPhylabModal(`Welcome back!`, true, () => {
              window.location.href = "PhyLab_user_page.html";
            });
          } else {
            const err = await res.json().catch(() => ({}));
            const msg =
              err.detail ||
              Object.entries(err)
                .map(([k, v]) => `${k}: ${Array.isArray(v) ? v.join(" ") : v}`)
                .join(" | ") ||
              "Invalid credentials.";
            const loginErr = document.getElementById("loginError");
            if (loginErr) {
              loginErr.textContent = msg;
              loginErr.style.display = "block";
            }
            document.getElementById("username").classList.add("input-error");
            document
              .getElementById("password_login")
              .classList.add("input-error");
          }
        } catch (e) {
          console.error("Login network error", e);
          showPhylabModal("Network error: could not reach server.", false);
        } finally {
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = "Login";
          }
        }
      }

      function checkAdminAccess() {
        // kept for backward compatibility: open modal
        openAdminModal();
      }

      // Admin modal helpers
      const ADMIN_KEY = "PhyL4b!2026";
      function openAdminModal() {
        const modal = document.getElementById("adminModal");
        const err = document.getElementById("adminKeyError");
        const input = document.getElementById("adminKeyInput");
        if (!modal) return;
        if (err) {
          err.textContent = "";
          err.style.display = "none";
        }
        if (input) {
          input.classList.remove("input-error");
          input.value = "";
        }
        modal.style.display = "flex";
        setTimeout(() => {
          if (input) input.focus();
        }, 50);
      }

      function closeAdminModal() {
        const modal = document.getElementById("adminModal");
        const input = document.getElementById("adminKeyInput");
        if (modal) modal.style.display = "none";
        if (input) {
          input.value = "";
          input.classList.remove("input-error");
        }
      }

      function submitAdminKey() {
        const input = document.getElementById("adminKeyInput");
        const err = document.getElementById("adminKeyError");
        const value = input ? input.value : "";
        if (value === ADMIN_KEY) {
          closeAdminModal();
          window.location.href = "PhyLab_admin_page.html";
        } else {
          if (err) {
            err.textContent = "Access Denied: Unauthorized Personnel.";
            err.style.display = "block";
          }
          if (input) input.classList.add("input-error");
        }
      }
      // Toggle password visibility (used by login and register password fields)
      function togglePassword(inputId, btn) {
        const input = document.getElementById(inputId);
        if (!input || !btn) return;
        const eyeSvg =
          '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 5C7 5 2.7 8.1 1 12c1.7 3.9 6 7 11 7s9.3-3.1 11-7c-1.7-3.9-6-7-11-7z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
        const eyeSlashSvg =
          '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M17.94 17.94A10.94 10.94 0 0 1 12 19c-5 0-9.3-3.1-11-7 .7-1.7 1.8-3.2 3.1-4.5M3 3l18 18" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9.88 9.88a3 3 0 0 0 4.24 4.24" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>';

        const isPassword = input.type === "password";
        if (isPassword) {
          input.type = "text";
          btn.setAttribute("aria-pressed", "true");
          btn.setAttribute("title", "Hide password");
          btn.innerHTML = eyeSlashSvg;
        } else {
          input.type = "password";
          btn.setAttribute("aria-pressed", "false");
          btn.setAttribute("title", "Show password");
          btn.innerHTML = eyeSvg;
        }
      }

      // wire admin modal buttons and Enter key
      (function attachAdminModalHandlers() {
        const submitBtn = document.getElementById("adminSubmitBtn");
        const cancelBtn = document.getElementById("adminCancelBtn");
        const input = document.getElementById("adminKeyInput");
        if (submitBtn) submitBtn.addEventListener("click", submitAdminKey);
        if (cancelBtn) cancelBtn.addEventListener("click", closeAdminModal);
        if (input)
          input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") submitAdminKey();
          });
      })();

      // Clear inline error when user edits inputs
      (function attachLoginInputClear() {
        const uname = document.getElementById("username");
        const pwd = document.getElementById("password_login");
        const clear = () => {
          const err = document.getElementById("loginError");
          if (err) {
            err.textContent = "";
            err.style.display = "none";
          }
          if (uname) uname.classList.remove("input-error");
          if (pwd) pwd.classList.remove("input-error");
        };
        if (uname) uname.addEventListener("input", clear);
        if (pwd) pwd.addEventListener("input", clear);
      })();
    </script>
  </body>
</html>
