<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phylab - User Page</title>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="Phylab_theme_vars.css" />
    <link rel="stylesheet" href="PhyLab_user_page_style.css" />

    <!-- External Scripts (non-module) -->
    <script src="js/config.js"></script>
    <script src="supabase_fetch.js"></script>
    <script src="inventory_data.js"></script>
  </head>
  <body class="wholescreen">
    <!-- ============================================
         HEADER / NAVIGATION SECTION
         ============================================ -->
    <div class="admin-header">
      <div class="header-title">
        <h1 class="title">PhyLab</h1>
      </div>

      <!-- Hamburger menu button (mobile only) -->
      <button
        class="hamburger-btn"
        id="hamburgerBtn"
        aria-label="Toggle menu"
        aria-expanded="false"
      >
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </button>

      <!-- Navigation items (collapsible on mobile) -->
      <div class="nav-items" id="navItems">
        <div class="logout">
          <div
            class="user-profile"
            onclick="toggleProfile(true)"
            aria-label="Open profile"
            title="Profile"
          >
            <svg
              class="user-profile-icon"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 512 512"
            >
              <path
                d="M399 384.2C376.9 345.8 335.4 320 288 320l-64 0c-47.4 0-88.9 25.8-111 64.2 35.2 39.2 86.2 63.8 143 63.8s107.8-24.7 143-63.8zM0 256a256 256 0 1 1 512 0 256 256 0 1 1 -512 0zm256 16a72 72 0 1 0 0-144 72 72 0 1 0 0 144z"
              />
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================
         MAIN CONTENT AREA
         ============================================ -->
    <div class="admin-body">
      <div class="main-content">
        <!-- Hero Welcome Section -->
        <div class="welcome-hero-section">
          <div class="welcome-hero-overlay"></div>
          <div class="welcome-hero-content">
            <h1 class="welcome-hero-title">Welcome to PhyLab!</h1>
            <p class="welcome-hero-subtitle">
              Your one-stop solution for managing physics laboratory equipment
              and materials.
            </p>
            <div class="welcome-hero-features">
              <button
                id="findEquipmentBtn"
                class="hero-feature hero-action"
                type="button"
                aria-label="Find Equipment"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 512 512"
                >
                  <path
                    d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"
                  />
                </svg>
                <span>Find Equipment</span>
              </button>
              <button
                id="borrowItemsBtn"
                class="hero-feature hero-action"
                type="button"
                aria-label="Borrow Items"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 576 512"
                >
                  <path
                    d="M0 24C0 10.7 10.7 0 24 0L69.5 0c22 0 41.5 12.8 50.6 32l411 0c26.3 0 45.5 25 38.6 50.4l-41 152.3c-8.5 31.4-37 53.3-69.5 53.3l-288.5 0 5.4 28.5c2.2 11.3 12.1 19.5 23.6 19.5L488 336c13.3 0 24 10.7 24 24s-10.7 24-24 24l-288.3 0c-34.6 0-64.3-24.6-70.7-58.5L77.4 54.5c-.7-3.8-4-6.5-7.9-6.5L24 48C10.7 48 0 37.3 0 24zM128 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm336-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z"
                  />
                </svg>
                <span>Borrow Items</span>
              </button>
              <button
                id="trackReturnsBtn"
                class="hero-feature hero-action"
                type="button"
                aria-label="Track Returns"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 512 512"
                >
                  <path
                    d="M256 0a256 256 0 1 1 0 512A256 256 0 1 1 256 0zM232 120l0 136c0 8 4 15.5 10.7 20l96 64c11 7.4 25.9 4.4 33.3-6.7s4.4-25.9-6.7-33.3L280 243.2 280 120c0-13.3-10.7-24-24-24s-24 10.7-24 24z"
                  />
                </svg>
                <span>Track Returns</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Available Inventory Section -->
        <div class="available-inventory">
          <h2 class="available-inventory-header">Available Inventory</h2>

          <!-- Toolbar: search + category filters -->
          <div class="inventory-toolbar">
            <div class="toolbar-search">
              <svg
                class="toolbar-search-icon"
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="11" cy="11" r="7"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
              <input
                id="userInventorySearch"
                class="toolbar-search-input"
                type="search"
                placeholder="Search equipment, tools, or items..."
                aria-label="Search inventory"
              />
            </div>
            <div class="toolbar-filters">
              <button class="filter-btn active" data-filter="all">
                All Items
              </button>
              <button class="filter-btn" data-filter="apparatus">
                Apparatus
              </button>
              <button class="filter-btn" data-filter="tools">Tools</button>
              <button class="filter-btn" data-filter="equipment">
                Equipment
              </button>
              <button class="filter-btn" data-filter="consumable">
                Consumables
              </button>
            </div>
          </div>

          <!-- Inventory Container (dynamically populated) -->
          <div class="inventory-list-wrapper">
            <div class="inventory-section" id="inventoryContainer">
              <div class="loading-inventory">
                <div class="loading-spinner"></div>
                <p>Loading inventory...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Request history is now shown in a modal; trigger is a floating button -->
    </div>

    <!-- ============================================
         FLOATING BORROW BUTTON
         ============================================ -->
    <button
      id="borrowToggleButton"
      class="borrow-toggle-button"
      aria-label="Open borrow panel"
    >
      <span class="borrow-count-badge" id="borrow-count">0</span>
      Borrow
    </button>

    <!-- Floating History Button (opens request history modal) -->
    <button
      id="historyToggleButton"
      class="history-toggle-button"
      aria-label="Open request history"
    >
      History
    </button>

    <!-- HISTORY MODAL -->
    <div id="historyModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-content">
        <span class="close-btn" id="closeHistoryModal">&times;</span>
        <h2>Request History</h2>
        <!-- Details pane: populated when a request is clicked -->
        <div
          id="historyDetailPane"
          class="history-detail"
          style="display: none; margin-bottom: 12px"
        ></div>
        <div class="modal-body" id="myRequestsContainer">
          <div style="padding: 20px; color: #666">Loading requests...</div>
        </div>
      </div>
    </div>

    <!-- ============================================
         BORROW MODAL / REQUEST FORM
         ============================================ -->
    <div class="request-form">
      <div id="borrowModal" class="modal-overlay">
        <div class="modal-content">
          <span class="close-btn" onclick="toggleModal(false)">&times;</span>
          <h2>Borrow Request Form</h2>

          <div class="modal-body">
            <p style="color: var(--color-primary); font-weight: bold">
              Selected Items
            </p>
            <div id="selectedItemsContainer"></div>

            <form id="borrowForm">
              <label>Your Full Name</label>
              <input
                type="text"
                id="user-fullname"
                placeholder="Enter your name"
                required
              />

              <label style="transition: opacity 0.3s ease">Student ID</label>
              <input
                type="text"
                id="user-id"
                placeholder="Enter your ID"
                required
                style="transition: opacity 0.3s ease"
              />

              <label style="transition: opacity 0.3s ease"
                >Teacher's Name</label
              >
              <select
                id="teacher-name"
                required
                style="transition: opacity 0.3s ease"
              >
                <option value="">-- Select teacher --</option>
              </select>

              <label>Purpose of Borrowing</label>
              <textarea id="purpose-text" rows="3" required></textarea>

              <div class="date-container">
                <div>
                  <label>Borrow Date</label>
                  <input type="date" id="borrow-date" required />
                </div>
                <div>
                  <label>Return Date</label>
                  <input type="date" id="return-date" required />
                </div>
              </div>

              <button type="submit" class="submit-btn">Submit Request</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================
         PROFILE MODAL
         ============================================ -->
    <div id="profile-modal" class="profile-modal">
      <div class="profile-card">
        <span class="close-profile" onclick="toggleProfile(false)"
          >&times;</span
        >
        <div class="profile-header">
          <div class="profile-avatar">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </div>
          <h2 id="display-fullname">User Name</h2>
          <p id="display-role">User</p>
        </div>
        <div class="profile-info">
          <div class="info-item">
            <strong>ID Number:</strong> <span id="display-id">---</span>
          </div>
          <div class="info-item">
            <strong>Email:</strong> <span id="display-email">---</span>
          </div>
        </div>

        <button
          id="open-review-btn"
          class="review-btn"
          type="button"
          style="
            margin-top: 15px;
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
          "
        >
          Submit a Review
        </button>

        <button class="logout-btn" onclick="handleLogout()">Logout</button>
      </div>
    </div>

    <!-- ============================================
         REVIEW MODAL
         ============================================ -->
    <div
      id="review-modal"
      class="profile-modal"
      style="display: none; z-index: 3000"
    >
      <div class="profile-card" style="width: 400px; max-width: 90%">
        <h3>Submit Item Feedback</h3>
        <p style="font-size: 0.8rem; color: #666; margin-bottom: 15px">
          Provide details on equipment condition.
        </p>

        <div style="text-align: left; margin-bottom: 12px">
          <label style="font-size: 0.8rem; font-weight: bold; color: #444"
            >Item Name:</label
          >
          <input
            type="text"
            id="review-item-name"
            placeholder="e.g., Ammeter, Bunsen Burner"
            style="
              width: 100%;
              padding: 10px;
              border-radius: 5px;
              border: 1px solid #ccc;
              margin-top: 5px;
              box-sizing: border-box;
            "
          />
        </div>

        <div style="text-align: left; margin-bottom: 12px">
          <label style="font-size: 0.8rem; font-weight: bold; color: #444"
            >Upload Photo:</label
          >
          <input
            type="file"
            id="review-image"
            accept="image/*"
            style="width: 100%; font-size: 0.8rem; margin-top: 5px"
          />
        </div>

        <textarea
          id="review-comment"
          placeholder="Describe the issue or condition..."
          style="
            width: 100%;
            height: 80px;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            font-family: inherit;
          "
        ></textarea>

        <div style="display: flex; gap: 10px">
          <button
            id="cancel-review-btn"
            type="button"
            style="
              flex: 1;
              padding: 10px;
              border-radius: 5px;
              border: 1px solid #ccc;
              cursor: pointer;
            "
          >
            Cancel
          </button>
          <button
            id="submit-review-btn"
            type="button"
            style="
              flex: 1;
              padding: 10px;
              border-radius: 5px;
              border: none;
              background: var(--color-primary);
              color: white;
              cursor: pointer;
            "
          >
            Submit
          </button>
        </div>
      </div>
    </div>

    <!-- ============================================
         PAGE FEEDBACK SECTION (reuses item feedback implementation)
         ============================================ -->
    <div class="page-feedback">
      <div class="page-feedback-card">
        <div class="page-feedback-inner">
          <div class="page-feedback-info">
            <h2 style="margin-top: 0">We value your feedback</h2>
            <p style="color: #555; margin-top: 6px">
              Share site experience or equipment issues â€” your input helps us
              improve.
            </p>

            <h3 style="margin-top: 12px; color: var(--color-primary)">
              What to include
            </h3>
            <ul style="margin-top: 8px; color: #444; line-height: 1.6">
              <li>Where the issue happened (page or equipment)</li>
              <li>Steps to reproduce (if site-related)</li>
              <li>Condition of equipment and any identifying name/number</li>
              <li>Attach a photo if available to help us assess</li>
            </ul>

            <div style="margin-top: 12px; color: #444">
              <strong>Need urgent help?</strong>
              <p style="margin: 6px 0 0 0">
                Email
                <a href="mailto:phylabsofficial@gmail.com"
                  >phylabsofficial@gmail.com</a
                >
                or visit the lab office.
              </p>
            </div>
          </div>

          <div class="page-feedback-form">
            <label style="font-weight: 600; display: block; margin-bottom: 6px"
              >Subject</label
            >
            <input
              id="page-feedback-subject"
              type="text"
              placeholder="e.g., Site feedback, Loan process"
            />

            <label style="font-weight: 600; display: block; margin: 12px 0 6px"
              >Upload Photo (optional)</label
            >
            <input id="page-feedback-image" type="file" accept="image/*" />

            <label style="font-weight: 600; display: block; margin: 12px 0 6px"
              >Message</label
            >
            <textarea
              id="page-feedback-comment"
              rows="5"
              placeholder="Describe your feedback..."
            ></textarea>

            <div style="display: flex; gap: 10px; margin-top: 12px">
              <button
                id="page-feedback-submit"
                type="button"
                class="btn-primary"
              >
                Send Feedback
              </button>
              <button
                id="page-feedback-clear"
                type="button"
                class="btn"
                style="background: #fff; border: 1px solid #ddd; color: #333"
              >
                Clear
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="landing-footer">
      <div class="footer-content">
        <p class="footer-text">
          &copy; 2026 PhyLab - Physics Laboratory Inventory System. All rights
          reserved.
        </p>
      </div>
    </footer>
    <!-- ============================================
         MODULAR JAVASCRIPT COMPONENTS
         Load all component modules
         ============================================ -->
    <script type="module" src="js/user-main.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const btn = document.getElementById("historyToggleButton");
        const modal = document.getElementById("historyModal");
        const closeBtn = document.getElementById("closeHistoryModal");
        const borrowBtn = document.getElementById("borrowToggleButton");

        function toggleModal(show) {
          if (!modal) return;
          // If we are showing the history modal, close borrow modal first
          try {
            if (show === undefined) {
              // toggling: determine target state
              const willShow = !modal.classList.contains("show");
              if (willShow) {
                const borrowModal = document.getElementById("borrowModal");
                if (borrowModal && borrowModal.classList.contains("show")) {
                  borrowModal.classList.remove("show");
                  borrowModal.style.display = "none";
                }
              }
            } else if (show) {
              const borrowModal = document.getElementById("borrowModal");
              if (borrowModal && borrowModal.classList.contains("show")) {
                borrowModal.classList.remove("show");
                borrowModal.style.display = "none";
              }
            }
          } catch (e) {}

          if (show === undefined) modal.classList.toggle("show");
          else if (show) modal.classList.add("show");
          else modal.classList.remove("show");
          modal.setAttribute(
            "aria-hidden",
            modal.classList.contains("show") ? "false" : "true",
          );
          // Ensure inline display is synchronized with the class (fixes conflicts
          // where other code sets `style.display = 'none'` directly).
          if (modal.classList.contains("show")) {
            modal.style.display = "flex";
            modal.setAttribute("aria-hidden", "false");
          } else {
            modal.style.display = "none";
            modal.setAttribute("aria-hidden", "true");
          }
          // hide detail pane when modal is closed
          const detail = document.getElementById("historyDetailPane");
          if (detail && !modal.classList.contains("show"))
            detail.style.display = "none";
        }

        if (btn && modal) {
          btn.addEventListener("click", function () {
            toggleModal();
          });
        }

        if (closeBtn && modal) {
          closeBtn.addEventListener("click", function () {
            toggleModal(false);
          });
        }

        if (modal) {
          modal.addEventListener("click", function (e) {
            if (e.target === modal) toggleModal(false);
          });
        }

        // Hero action buttons: find equipment, open borrow modal, open history
        const findBtn = document.getElementById("findEquipmentBtn");
        const borrowHeroBtn = document.getElementById("borrowItemsBtn");
        const trackBtnHero = document.getElementById("trackReturnsBtn");

        if (findBtn) {
          findBtn.addEventListener("click", function () {
            const inv = document.querySelector(".available-inventory");
            if (inv) inv.scrollIntoView({ behavior: "smooth", block: "start" });
            const search = document.getElementById("userInventorySearch");
            if (search) setTimeout(() => search.focus(), 450);
          });
        }

        if (borrowHeroBtn) {
          borrowHeroBtn.addEventListener("click", function () {
            try {
              if (window.toggleModal) window.toggleModal(true);
              else document.getElementById("borrowToggleButton")?.click();
            } catch (e) {}
          });
        }

        if (trackBtnHero) {
          trackBtnHero.addEventListener("click", function () {
            document.getElementById("historyToggleButton")?.click();
          });
        }

        // Position history button to the left of the borrow button when possible
        function positionHistoryButton() {
          if (!btn || !borrowBtn) return;
          const gap = 16; // px gap between buttons (increased)
          const bRect = borrowBtn.getBoundingClientRect();
          // match width/height to borrow button for identical sizing
          try {
            const borrowWidth = Math.max(80, borrowBtn.offsetWidth || 100);
            const borrowHeight = borrowBtn.offsetHeight || 40;
            btn.style.width = borrowWidth + "px";
            btn.style.height = borrowHeight + "px";
            btn.style.lineHeight = borrowHeight + "px";
            // compute left so history sits to the left of borrow with gap
            const leftPos = Math.max(8, bRect.left - borrowWidth - gap);
            const bottomPos = window.innerHeight - bRect.bottom; // keeps same bottom offset as borrow button
            btn.style.left = leftPos + "px";
            btn.style.bottom = bottomPos + "px";
            btn.style.right = "auto";
            btn.style.position = "fixed";
            // visually ensure text centered
            btn.style.display = "inline-flex";
            btn.style.alignItems = "center";
            btn.style.justifyContent = "center";
          } catch (e) {
            // fallback to default positioning
            const btnWidth = btn.offsetWidth || 100;
            const leftPos = Math.max(8, bRect.left - btnWidth - gap);
            const bottomPos = window.innerHeight - bRect.bottom;
            btn.style.left = leftPos + "px";
            btn.style.bottom = bottomPos + "px";
          }
        }

        // initial position and updates on resize/scroll
        setTimeout(positionHistoryButton, 50);
        window.addEventListener("resize", positionHistoryButton);
        window.addEventListener("scroll", positionHistoryButton, {
          passive: true,
        });
      });
    </script>
  </body>
</html>
